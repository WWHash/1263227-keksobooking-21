(()=>{"use strict";(()=>{const e=function(e,t){return Math.floor(Math.random()*(t-e))+e};let t=function(e){return e[Math.floor(Math.random()*e.length)]};window.util={getRandomElement:t,getRandomElements:function(n){let o=[];for(let r=0;r<e(0,n.length);r++){let e=t(n);o.includes(e)||o.push(e)}return o},getRandomNumber:e,toggleDisabled:function(e,t){for(let n=0;n<e.length;n++)e[n].disabled=t},showMessage:function(e){const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0);document.querySelector("main").appendChild(t),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),t.remove())})),t.addEventListener("click",(function(e){0===e.button&&(e.preventDefault(),t.remove())}))}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e=function(e,t,n,o,r){let i=new XMLHttpRequest;"GET"===e&&(i.responseType="json"),i.addEventListener("load",(function(){200===i.status?o(i.response):r(`Статус ответа: ${i.status} + ${i.statusText}`)})),i.addEventListener("error",(function(){r("Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.timeout=1e4,i.open(e,t),i.send(n)};window.backend={load:function(t,n){e("GET","https://21.javascript.pages.academy/keksobooking/data",null,t,n)},save:function(t,n,o){e("POST","https://30.javascript.pages.academy/keksobooking",t,n,o)},onError:function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=function(e){let t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);t.setAttribute("style",`left: ${e.location.x-25}px ; top: ${e.location.y-70}px`);const n=t.querySelector("img");return n.src=e.author.avatar,n.alt=e.offer.title,t.addEventListener("click",(function(){window.card.renderCard(e),t.classList.add("map__pin--active")})),t.addEventListener("keydown",(function(t){"Enter"===t.key&&window.card.renderCard(e)})),t},n=function(){let e=document.querySelectorAll(".map__pin");for(let t=1;t<e.length;t++)e[t].remove()};window.pin={drawPins:function(o){n();let r=document.createDocumentFragment();const i=Math.min(5,o.length);for(let e=0;e<i;e++)r.appendChild(t(o[e]));e.appendChild(r)},deletePins:n,mapPins:e}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("[name = capacity]"),n=e.querySelector("[name= rooms]"),o=e.querySelectorAll("fieldset"),r=e.querySelector("[name = address]"),i=e.querySelector("#type"),a=e.querySelector("#price"),c=e.querySelector("#timein"),u=e.querySelector("#timeout"),s=e.querySelector(".ad-form__reset"),l=function(e){n.value<t.value&&t.value>0&&"100"!==n.value?t.setCustomValidity("Вам нужна квартира побольше"):"100"===n.value&&t.value>0?t.setCustomValidity("Эти аппартаменты не для гостей"):"100"!==n.value&&"0"===t.value?t.setCustomValidity("Выберите аппартаменты не для гостей"):t.setCustomValidity(""),function(){let e=0;switch(i.value){case"flat":e=1e3;break;case"bungalo":e=0;break;case"house":e=5e3;break;case"palace":e=1e4}a.setAttribute("placeholder",e),a.setAttribute("min",e)}(),e&&e.target===c&&(u.value=c.value),e&&e.target===u&&(c.value=u.value)};e.addEventListener("submit",(function(t){const n=new FormData(e);t.preventDefault(),window.backend.save(n,(function(){window.map.deactivatePage(),window.util.showMessage("success")}),(function(){window.util.showMessage("error")}))})),s.addEventListener("click",(function(e){0===e.button&&(e.preventDefault(),window.map.deactivatePage())})),e.addEventListener("change",l),window.form={activate:function(){e.classList.remove("ad-form--disabled"),window.util.toggleDisabled(o,!1),l()},deactivate:function(){e.classList.add("ad-form--disabled"),window.util.toggleDisabled(o,!0),e.reset()},setAddress:function(e,t){r.value=`${e}, ${t}`}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map__filters"),n=t.querySelectorAll("input"),o=t.querySelectorAll("select"),r=document.querySelector(".map"),i=0-e.offsetWidth/2,a=r.offsetWidth-e.offsetWidth/2,c=130-e.offsetHeight,u=630-e.offsetHeight,s=e.offsetLeft,l=e.offsetTop;let d=[];const f=function(t){let n=e.getBoundingClientRect(),o=parseInt(e.style.left,10),r=parseInt(e.style.top,10),i=Math.round(o+n.width/2),a=t?n.height/2:n.height,c=Math.round(r+a);window.form.setAddress(i,c)},p=function(){r.classList.remove("map--faded"),f(),window.backend.load((function(e){window.util.toggleDisabled(o,!1),window.util.toggleDisabled(n,!1),window.pin.drawPins(e),d=e}),window.backend.onError),window.form.activate(),e.removeEventListener("mousedown",w),e.removeEventListener("keydown",y)},m=function(){r.classList.add("map--faded"),window.util.toggleDisabled(o,!0),window.util.toggleDisabled(n,!0),window.pin.deletePins(),window.form.deactivate(),e.style.top=l+"px",e.style.left=s+"px",f(!0),e.addEventListener("mousedown",w),e.addEventListener("keydown",y)},w=function(e){0===e.button&&p()},y=function(e){"Enter"===e.key&&p()};e.addEventListener("mousedown",(function(t){t.preventDefault();let n={x:t.clientX,y:t.clientY};const o=function(t){t.preventDefault();let o=n.x-t.clientX,r=n.y-t.clientY;n={x:t.clientX,y:t.clientY};const s=e.offsetTop-r,l=e.offsetLeft-o;l>=i&&l<=a&&s>=c&&s<=u&&(e.style.top=s+"px",e.style.left=l+"px",f())},r=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)})),m(),window.map={getOriginalOffers:()=>d,getMapElement:()=>r,deactivatePage:m}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelectorAll("input"),a=function(e,t){switch(e){case"any":return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4;default:return!1}},c=function(e){for(let t=0;t<i.length;t++)if(i[t].checked&&!e.includes(i[t].value))return!1;return!0},u=function(e,t){return""+t===e||"any"===e};e.addEventListener("change",window.debounce((function(){const e=window.map.getOriginalOffers(),i=[];for(const s of e)if(u(t.value,s.offer.type)&&u(o.value,s.offer.rooms)&&u(r.value,s.offer.guests)&&a(n.value,s.offer.price)&&c(s.offer.features)&&(i.push(s),5===i.length))break;window.card.closeCard(),window.pin.drawPins(i)})))})(),(()=>{const e=function(e,t){t?e.textContent=t:e.classList.add("hidden")},t=function(){const e=document.querySelector(".map__card"),t=document.querySelector(".map__pin--active");e&&(t.classList.remove("map__pin--active"),e.remove())};document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),t())})),window.card={renderCard:function(n){t();let o=function(t){let n=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=n.querySelector(".popup__title"),r=n.querySelector(".popup__text--address"),i=n.querySelector(".popup__text--price"),a=n.querySelector(".popup__type"),c=n.querySelector(".popup__text--capacity"),u=n.querySelector(".popup__text--time"),s=n.querySelector(".popup__features"),l=n.querySelector(".popup__description"),d=n.querySelector(".popup__avatar"),f=n.querySelector(".popup__photos");var p,m,w,y;return e(o,t.offer.title),e(r,t.offer.address),e(i,t.offer.price+" р/ночь"),e(a,function(e){let t;switch(e){case"flat":t="Квартира";break;case"bungalo":t="Бунгало";break;case"house":t="Дом";break;case"palace":t="Дворец"}return t}(t.offer.type)),e(c,`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`),e(u,`Заезд после ${t.offer.checkin} выезд до ${t.offer.checkout}`),p=s,(m=t.offer.features)&&m.length>0?m.forEach((function(e){p.querySelector(".popup__feature--"+e).classList.remove("hidden")})):p.classList.add("hidden"),e(l,t.offer.description),w=d,(y=t.author.avatar)?w.src=y:w.classList.add("hidden"),function(e,t){const n=e.querySelector("img");t&&t.length>0?(t.forEach((function(t){const o=n.cloneNode(!0);o.src=t,e.appendChild(o)})),n.remove()):e.classList.add("hidden")}(f,t.offer.photos),n}(n),r=window.map.getMapElement();const i=r.querySelector(".map__filters-container");r.insertBefore(o,i),o.querySelector(".popup__close").addEventListener("click",(function(e){0===e.button&&t()}))},closeCard:t}})()})();