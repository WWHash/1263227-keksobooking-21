(()=>{"use strict";window.util={toggleDisabled:(e,t)=>{for(let o=0;o<e.length;o++)e[o].disabled=t},showMessage:e=>{const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0);document.querySelector("main").appendChild(t),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),t.remove())})),t.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),t.remove())}))},OffersType:{FLAT:"flat",BUNGALO:"bungalo",HOUSE:"house",PALACE:"palace"}},window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="POST",t="GET",o=(e,o,r,n,s)=>{const a=new XMLHttpRequest;e===t&&(a.responseType="json"),a.addEventListener("load",(()=>{200===a.status?n(a.response):s(`Статус ответа: ${a.status} + ${a.statusText}`)})),a.addEventListener("error",(()=>{s("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{s(`Запрос не успел выполниться за ${a.timeout} мс`)})),a.timeout=1e4,a.open(e,o),a.send(r)};window.backend={load:(e,r)=>{o(t,"https://21.javascript.pages.academy/keksobooking/data",null,e,r)},save:(t,r,n)=>{o(e,"https://21.javascript.pages.academy/keksobooking",t,r,n)},onError:e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);t.setAttribute("style",`left: ${e.location.x-25}px ; top: ${e.location.y-70}px`);const o=t.querySelector("img");return o.src=e.author.avatar,o.alt=e.offer.title,t.addEventListener("click",(()=>{window.card.render(e),t.classList.add("map__pin--active")})),t.addEventListener("keydown",(t=>{"Enter"===t.key&&window.card.render(e)})),t},o=()=>{const e=document.querySelectorAll(".map__pin");for(let t=1;t<e.length;t++)e[t].remove()};window.pin={drawPins:r=>{o();const n=document.createDocumentFragment(),s=Math.min(5,r.length);for(let e=0;e<s;e++)n.appendChild(t(r[e]));e.appendChild(n)},deletePins:o}})(),(()=>{const e="0",t="0",o="1000",r="5000",n="10000",s=document.querySelector(".ad-form"),a=s.querySelector("[name = capacity]"),i=s.querySelector("[name= rooms]"),l=s.querySelectorAll("fieldset"),d=s.querySelector("[name = address]"),c=s.querySelector("#type"),u=s.querySelector("#price"),p=s.querySelector("#timein"),f=s.querySelector("#timeout"),m=s.querySelector(".ad-form__reset"),w=s=>{i.value<a.value&&a.value>e&&"100"!==i.value?a.setCustomValidity("Вам нужна квартира побольше"):"100"===i.value&&a.value>e?a.setCustomValidity("Эти аппартаменты не для гостей"):i.value!==e&&a.value===e?a.setCustomValidity("Выберите аппартаменты не для гостей"):a.setCustomValidity(""),(()=>{let e=0;switch(c.value){case window.util.OffersType.FLAT:e=o;break;case window.util.OffersType.BUNGALO:e=t;break;case window.util.OffersType.HOUSE:e=r;break;case window.util.OffersType.PALACE:e=n}u.setAttribute("placeholder",e),u.setAttribute("min",e)})(),s&&s.target===p&&(f.value=p.value),s&&s.target===f&&(p.value=f.value)};s.addEventListener("submit",(e=>{const t=new FormData(s);e.preventDefault(),window.backend.save(t,(()=>{window.map.deactivatePage(),window.util.showMessage("success")}),(()=>{window.util.showMessage("error")}))})),m.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),window.map.deactivatePage())})),s.addEventListener("change",w),window.form={activate:()=>{s.classList.remove("ad-form--disabled"),window.util.toggleDisabled(l,!1),w()},deactivate:()=>{s.classList.add("ad-form--disabled"),window.util.toggleDisabled(l,!0),s.reset()},setAddress:(e,t)=>{d.value=`${e}, ${t}`}}})(),(()=>{const e="map--faded",t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__filters"),r=o.querySelectorAll("input"),n=o.querySelectorAll("select"),s=document.querySelector(".map"),a=Math.floor(0-t.offsetWidth/2),i=s.offsetWidth-t.offsetWidth/2,l=130-t.offsetHeight,d=630-t.offsetHeight,c=t.offsetLeft,u=t.offsetTop;let p=[];const f=e=>{const o=t.getBoundingClientRect(),r=parseInt(t.style.left,10),n=parseInt(t.style.top,10),s=Math.round(r+o.width/2),a=e?o.height/2:o.height,i=Math.round(n+a);window.form.setAddress(s,i)},m=()=>{s.classList.remove(e),f(),window.backend.load((e=>{window.util.toggleDisabled(n,!1),window.util.toggleDisabled(r,!1),window.pin.drawPins(e),p=e}),window.backend.onError),window.form.activate(),t.removeEventListener("mousedown",y),t.removeEventListener("keydown",v)},w=()=>{s.classList.add(e),window.util.toggleDisabled(n,!0),window.util.toggleDisabled(r,!0),window.pin.deletePins(),window.form.deactivate(),t.style.top=u+"px",t.style.left=c+"px",f(!0),t.addEventListener("mousedown",y),t.addEventListener("keydown",v)},y=e=>{0===e.button&&m()},v=e=>{"Enter"===e.key&&m()};t.addEventListener("mousedown",(e=>{e.preventDefault();let o={x:e.clientX,y:e.clientY};const r=e=>{e.preventDefault();const r=o.x-e.clientX,n=o.y-e.clientY;o={x:e.clientX,y:e.clientY};const s=t.offsetTop-n,c=t.offsetLeft-r;c>=a&&c<=i&&s>=l&&s<=d&&(t.style.top=s+"px",t.style.left=c+"px",f())},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)})),w(),window.map={getOriginalOffers:()=>p,getElement:()=>s,deactivatePage:w}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),s=e.querySelectorAll("input"),a=(e,t)=>{switch(e){case"any":return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4;default:return!1}},i=e=>{for(let t=0;t<s.length;t++)if(s[t].checked&&!e.includes(s[t].value))return!1;return!0},l=(e,t)=>""+t===e||"any"===e;e.addEventListener("change",window.debounce((()=>{const e=window.map.getOriginalOffers(),s=[];for(const d of e)if(l(t.value,d.offer.type)&&l(r.value,d.offer.rooms)&&l(n.value,d.offer.guests)&&a(o.value,d.offer.price)&&i(d.offer.features)&&(s.push(d),5===s.length))break;window.card.close(),window.pin.drawPins(s)})))})(),(()=>{const e="hidden",t="Квартира",o="Бунгало",r="Дом",n="Дворец",s=(t,o)=>{o?t.textContent=o:t.classList.add(e)},a=()=>{const e=document.querySelector(".map__card");e&&(document.querySelector(".map__pin--active").classList.remove("map__pin--active"),e.remove())};document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),a())})),window.card={render:i=>{a();const l=(a=>{const i=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),l=i.querySelector(".popup__title"),d=i.querySelector(".popup__text--address"),c=i.querySelector(".popup__text--price"),u=i.querySelector(".popup__type"),p=i.querySelector(".popup__text--capacity"),f=i.querySelector(".popup__text--time"),m=i.querySelector(".popup__features"),w=i.querySelector(".popup__description"),y=i.querySelector(".popup__avatar"),v=i.querySelector(".popup__photos");var g,h,S,_;return s(l,a.offer.title),s(d,a.offer.address),s(c,a.offer.price+" р/ночь"),s(u,(e=>{let s;switch(e){case window.util.OffersType.FLAT:s=t;break;case window.util.OffersType.BUNGALO:s=o;break;case window.util.OffersType.HOUSE:s=r;break;case window.util.OffersType.PALACE:s=n}return s})(a.offer.type)),s(p,`${a.offer.rooms} комнаты для ${a.offer.guests} гостей`),s(f,`Заезд после ${a.offer.checkin} выезд до ${a.offer.checkout}`),g=m,(h=a.offer.features)&&h.length>0?h.forEach((t=>{g.querySelector(".popup__feature--"+t).classList.remove(e)})):g.classList.add(e),s(w,a.offer.description),S=y,(_=a.author.avatar)?S.src=_:S.classList.add(e),((t,o)=>{const r=t.querySelector("img");o&&o.length>0?(o.forEach((e=>{const o=r.cloneNode(!0);o.src=e,t.appendChild(o)})),r.remove()):t.classList.add(e)})(v,a.offer.photos),i})(i),d=window.map.getElement(),c=d.querySelector(".map__filters-container");d.insertBefore(l,c),l.querySelector(".popup__close").addEventListener("click",(e=>{0===e.button&&a()}))},close:a}})()})();