(()=>{"use strict";window.util={toggleDisabled:function(e,t){for(let n=0;n<e.length;n++)e[n].disabled=t},showMessage:function(e){const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0);document.querySelector("main").appendChild(t),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),t.remove())})),t.addEventListener("click",(function(e){0===e.button&&(e.preventDefault(),t.remove())}))},OffersType:{FLAT:"flat",BUNGALO:"bungalo",HOUSE:"house",PALACE:"palace"}},window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e="POST",t="GET",n=function(e,n,o,r,i){const c=new XMLHttpRequest;e===t&&(c.responseType="json"),c.addEventListener("load",(function(){200===c.status?r(c.response):i(`Статус ответа: ${c.status} + ${c.statusText}`)})),c.addEventListener("error",(function(){i("Произошла ошибка соединения")})),c.addEventListener("timeout",(function(){i(`Запрос не успел выполниться за ${c.timeout} мс`)})),c.timeout=1e4,c.open(e,n),c.send(o)};window.backend={load:function(e,o){n(t,"https://21.javascript.pages.academy/keksobooking/data",null,e,o)},save:function(t,o,r){n(e,"https://30.javascript.pages.academy/keksobooking",t,o,r)},onError:function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=function(e){const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);t.setAttribute("style",`left: ${e.location.x-25}px ; top: ${e.location.y-70}px`);const n=t.querySelector("img");return n.src=e.author.avatar,n.alt=e.offer.title,t.addEventListener("click",(function(){window.card.renderCard(e),t.classList.add("map__pin--active")})),t.addEventListener("keydown",(function(t){"Enter"===t.key&&window.card.renderCard(e)})),t},n=function(){const e=document.querySelectorAll(".map__pin");for(let t=1;t<e.length;t++)e[t].remove()};window.pin={drawPins:function(o){n();const r=document.createDocumentFragment(),i=Math.min(5,o.length);for(let e=0;e<i;e++)r.appendChild(t(o[e]));e.appendChild(r)},deletePins:n}})(),(()=>{const e="0",t="0",n="1000",o="5000",r="10000",i=document.querySelector(".ad-form"),c=i.querySelector("[name = capacity]"),s=i.querySelector("[name= rooms]"),a=i.querySelectorAll("fieldset"),u=i.querySelector("[name = address]"),d=i.querySelector("#type"),l=i.querySelector("#price"),f=i.querySelector("#timein"),p=i.querySelector("#timeout"),m=i.querySelector(".ad-form__reset"),w=function(i){s.value<c.value&&c.value>e&&"100"!==s.value?c.setCustomValidity("Вам нужна квартира побольше"):"100"===s.value&&c.value>e?c.setCustomValidity("Эти аппартаменты не для гостей"):s.value!==e&&c.value===e?c.setCustomValidity("Выберите аппартаменты не для гостей"):c.setCustomValidity(""),function(){let e=0;switch(d.value){case window.util.OffersType.FLAT:e=n;break;case window.util.OffersType.BUNGALO:e=t;break;case window.util.OffersType.HOUSE:e=o;break;case window.util.OffersType.PALACE:e=r}l.setAttribute("placeholder",e),l.setAttribute("min",e)}(),i&&i.target===f&&(p.value=f.value),i&&i.target===p&&(f.value=p.value)};i.addEventListener("submit",(function(e){const t=new FormData(i);e.preventDefault(),window.backend.save(t,(function(){window.map.deactivatePage(),window.util.showMessage("success")}),(function(){window.util.showMessage("error")}))})),m.addEventListener("click",(function(e){0===e.button&&(e.preventDefault(),window.map.deactivatePage())})),i.addEventListener("change",w),window.form={activate:function(){i.classList.remove("ad-form--disabled"),window.util.toggleDisabled(a,!1),w()},deactivate:function(){i.classList.add("ad-form--disabled"),window.util.toggleDisabled(a,!0),i.reset()},setAddress:function(e,t){u.value=`${e}, ${t}`}}})(),(()=>{const e="map--faded",t=document.querySelector(".map__pin--main"),n=document.querySelector(".map__filters"),o=n.querySelectorAll("input"),r=n.querySelectorAll("select"),i=document.querySelector(".map"),c=0-t.offsetWidth/2,s=i.offsetWidth-t.offsetWidth/2,a=130-t.offsetHeight,u=630-t.offsetHeight,d=t.offsetLeft,l=t.offsetTop;let f=[];const p=function(e){const n=t.getBoundingClientRect(),o=parseInt(t.style.left,10),r=parseInt(t.style.top,10),i=Math.round(o+n.width/2),c=e?n.height/2:n.height,s=Math.round(r+c);window.form.setAddress(i,s)},m=function(){i.classList.remove(e),p(),window.backend.load((function(e){window.util.toggleDisabled(r,!1),window.util.toggleDisabled(o,!1),window.pin.drawPins(e),f=e}),window.backend.onError),window.form.activate(),t.removeEventListener("mousedown",y),t.removeEventListener("keydown",v)},w=function(){i.classList.add(e),window.util.toggleDisabled(r,!0),window.util.toggleDisabled(o,!0),window.pin.deletePins(),window.form.deactivate(),t.style.top=l+"px",t.style.left=d+"px",p(!0),t.addEventListener("mousedown",y),t.addEventListener("keydown",v)},y=function(e){0===e.button&&m()},v=function(e){"Enter"===e.key&&m()};t.addEventListener("mousedown",(function(e){e.preventDefault();let n={x:e.clientX,y:e.clientY};const o=function(e){e.preventDefault();const o=n.x-e.clientX,r=n.y-e.clientY;n={x:e.clientX,y:e.clientY};const i=t.offsetTop-r,d=t.offsetLeft-o;d>=c&&d<=s&&i>=a&&i<=u&&(t.style.top=i+"px",t.style.left=d+"px",p())},r=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)})),w(),window.map={getOriginalOffers:()=>f,getMapElement:()=>i,deactivatePage:w}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelectorAll("input"),c=function(e,t){switch(e){case"any":return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4;default:return!1}},s=function(e){for(let t=0;t<i.length;t++)if(i[t].checked&&!e.includes(i[t].value))return!1;return!0},a=function(e,t){return""+t===e||"any"===e};e.addEventListener("change",window.debounce((function(){const e=window.map.getOriginalOffers(),i=[];for(const u of e)if(a(t.value,u.offer.type)&&a(o.value,u.offer.rooms)&&a(r.value,u.offer.guests)&&c(n.value,u.offer.price)&&s(u.offer.features)&&(i.push(u),5===i.length))break;window.card.closeCard(),window.pin.drawPins(i)})))})(),(()=>{const e="hidden",t="Квартира",n="Бунгало",o="Дом",r="Дворец",i=function(t,n){n?t.textContent=n:t.classList.add(e)},c=function(){const e=document.querySelector(".map__card");e&&(document.querySelector(".map__pin--active").classList.remove("map__pin--active"),e.remove())};document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),c())})),window.card={renderCard:function(s){c();const a=function(c){const s=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),a=s.querySelector(".popup__title"),u=s.querySelector(".popup__text--address"),d=s.querySelector(".popup__text--price"),l=s.querySelector(".popup__type"),f=s.querySelector(".popup__text--capacity"),p=s.querySelector(".popup__text--time"),m=s.querySelector(".popup__features"),w=s.querySelector(".popup__description"),y=s.querySelector(".popup__avatar"),v=s.querySelector(".popup__photos");var g,h,S,_;return i(a,c.offer.title),i(u,c.offer.address),i(d,c.offer.price+" р/ночь"),i(l,function(e){let i;switch(e){case window.util.OffersType.FLAT:i=t;break;case window.util.OffersType.BUNGALO:i=n;break;case window.util.OffersType.HOUSE:i=o;break;case window.util.OffersType.PALACE:i=r}return i}(c.offer.type)),i(f,`${c.offer.rooms} комнаты для ${c.offer.guests} гостей`),i(p,`Заезд после ${c.offer.checkin} выезд до ${c.offer.checkout}`),g=m,(h=c.offer.features)&&h.length>0?h.forEach((function(t){g.querySelector(".popup__feature--"+t).classList.remove(e)})):g.classList.add(e),i(w,c.offer.description),S=y,(_=c.author.avatar)?S.src=_:S.classList.add(e),function(t,n){const o=t.querySelector("img");n&&n.length>0?(n.forEach((function(e){const n=o.cloneNode(!0);n.src=e,t.appendChild(n)})),o.remove()):t.classList.add(e)}(v,c.offer.photos),s}(s),u=window.map.getMapElement(),d=u.querySelector(".map__filters-container");u.insertBefore(a,d),a.querySelector(".popup__close").addEventListener("click",(function(e){0===e.button&&c()}))},closeCard:c}})()})();